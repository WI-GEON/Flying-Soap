name: Unity Docker CI (2022.3.26f1)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # ─────────────────────────────────────────────
  # 1) PlayMode Tests in Docker
  # ─────────────────────────────────────────────
  test:
    name: PlayMode Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Write Unity license file
        # 시크릿에 저장한 .ulf 내용을 담은 파일을 생성
        run: echo "${{ secrets.UNITY_LICENSE }}" > unity.ulf

      - name: Pull Unity Docker image
        run: docker pull unityci/editor:ubuntu-2022.3.26f1-windows-mono-3.0.1

      - name: Run PlayMode Tests
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/unity.ulf:/root/.local/share/unity3d/Unity_lic.ulf \
            unityci/editor:ubuntu-2022.3.26f1-windows-mono-3.0.1 \
            /opt/unity/Editor/Unity \
              -batchmode \
              -projectPath /workspace \
              -runTests \
              -testPlatform PlayMode \
              -testResults /workspace/TestResults.xml \
              -quit \
          && echo "▶ PlayMode Tests passed"

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with:
          name: PlayMode-TestResults
          path: TestResults.xml

  # ─────────────────────────────────────────────
  # 2) Build Standalone Windows in Docker
  # ─────────────────────────────────────────────
  build:
    name: Build Windows Standalone
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Write Unity license file
        run: echo "${{ secrets.UNITY_LICENSE }}" > unity.ulf

      - name: Pull Unity Docker image
        run: docker pull unityci/editor:ubuntu-2022.3.26f1-windows-mono-3.0.1

      - name: Build Windows Executable
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -v ${{ github.workspace }}/unity.ulf:/root/.local/share/unity3d/Unity_lic.ulf \
            unityci/editor:ubuntu-2022.3.26f1-windows-mono-3.0.1 \
            /opt/unity/Editor/Unity \
              -batchmode \
              -projectPath /workspace \
              -buildWindows64Player /workspace/build/Windows/Game.exe \
              -quit \
          && echo "▶ Build succeeded"

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Windows-Build
          path: build/Windows
